# 水印去除功能配置说明

## 功能概述

本服务支持对接三大云服务商的AI去水印功能：
- **阿里云** - 图像处理服务
- **腾讯云** - 图像处理服务
- **百度云** - 图像增强服务

## 配置方式

### 1. 环境变量配置（推荐）

在系统环境变量或 `.env` 文件中配置：

```bash
# 阿里云
export ALIYUN_ACCESS_KEY_ID=your_access_key_id
export ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret

# 腾讯云
export TENCENT_SECRET_ID=your_secret_id
export TENCENT_SECRET_KEY=your_secret_key
export TENCENT_BUCKET=your_bucket_name

# 百度云
export BAIDU_API_KEY=your_api_key
export BAIDU_SECRET_KEY=your_secret_key
```

### 2. 配置文件配置

修改 `application.yml` 或 `application-prod.yml`:

```yaml
watermark-removal:
  enabled: true                      # 启用水印去除功能
  default-provider: aliyun           # 默认使用阿里云
  save-original: false               # 不保存原图
  timeout: 30000
  max-retry: 2
  
  aliyun:
    enabled: true                    # 启用阿里云
    access-key-id: your_key_id
    access-key-secret: your_key_secret
```

## 服务商申请指南

### 阿里云

1. **注册账号**: https://www.aliyun.com
2. **开通服务**: 控制台 → 图像处理 → 立即开通
3. **获取密钥**: 控制台 → AccessKey管理 → 创建AccessKey
4. **免费额度**: 新用户1000次，每月500次
5. **计费说明**: 超出后约 ¥0.05/次

### 腾讯云

1. **注册账号**: https://cloud.tencent.com
2. **开通服务**: 控制台 → 数据万象 → 立即开通
3. **创建存储桶**: 对象存储 → 存储桶列表 → 创建
4. **获取密钥**: 控制台 → 访问管理 → API密钥管理
5. **免费额度**: 新用户1000次/月
6. **计费说明**: 超出后约 ¥0.03/次

### 百度云

1. **注册账号**: https://cloud.baidu.com
2. **开通服务**: 控制台 → 图像处理 → 立即开通
3. **创建应用**: 图像处理 → 应用列表 → 创建应用
4. **获取密钥**: 应用详情 → API Key 和 Secret Key
5. **免费额度**: 每日500次
6. **计费说明**: 超出后约 ¥0.02/次

## 使用示例

### 示例 1: 不使用水印去除（默认）

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/36686673/all_photos",
    "targetDir": "douban_movie",
    "crawlAllPages": true,
    "maxPages": 10
  }'
```

### 示例 2: 使用阿里云去水印

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/36686673/all_photos",
    "targetDir": "douban_movie_clean",
    "crawlAllPages": true,
    "maxPages": 10,
    "removeWatermark": true,
    "watermarkProvider": "aliyun",
    "saveOriginal": false
  }'
```

### 示例 3: 使用腾讯云去水印并保存原图

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/36686673/all_photos",
    "targetDir": "douban_movie_tencent",
    "removeWatermark": true,
    "watermarkProvider": "tencent",
    "saveOriginal": true
  }'
```

### 示例 4: 使用百度云去水印

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/36686673/all_photos",
    "targetDir": "douban_movie_baidu",
    "removeWatermark": true,
    "watermarkProvider": "baidu"
  }'
```

## 参数说明

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| removeWatermark | Boolean | 否 | false | 是否启用水印去除 |
| watermarkProvider | String | 否 | 全局配置 | 服务商: aliyun, tencent, baidu |
| saveOriginal | Boolean | 否 | 全局配置 | 是否保存原图 |

## 响应示例

```json
{
  "code": 200,
  "message": "下载完成",
  "data": {
    "success": true,
    "totalCount": 50,
    "successCount": 48,
    "failCount": 2,
    "savePath": "./downloads/douban_movie_clean/20251230_180000",
    "duration": 125000,
    "watermarkStats": {
      "enabled": true,
      "provider": "aliyun",
      "processedCount": 48,
      "successCount": 45,
      "failCount": 3,
      "avgProcessTime": 1200,
      "failureReasons": [
        "图片格式不支持",
        "API调用超时"
      ]
    }
  }
}
```

## 成本估算

### 按月使用1000张图片

| 服务商 | 免费额度 | 超出费用 | 月成本 |
|--------|----------|----------|--------|
| 阿里云 | 500次 | ¥0.05/次 | ¥25 |
| 腾讯云 | 1000次 | ¥0.03/次 | ¥0（免费） |
| 百度云 | 每日500次 | ¥0.02/次 | ¥0（免费） |

### 建议

1. **小量使用** - 使用腾讯云或百度云的免费额度
2. **中量使用** - 混合使用多个服务商的免费额度
3. **大量使用** - 选择价格最优的服务商

## 常见问题

### Q1: 如何查看已使用的次数？

A: 查看日志或调用统计接口（后续功能）

### Q2: 去水印效果不好怎么办？

A: 不同服务商的效果略有差异，可以尝试切换服务商

### Q3: API调用失败怎么办？

A: 检查以下几点：
- 密钥是否正确
- 账户余额是否充足
- 免费额度是否用完
- 网络连接是否正常

### Q4: 可以同时使用多个服务商吗？

A: 可以，每次请求指定不同的 `watermarkProvider`

### Q5: 处理速度慢怎么办？

A: 
- 检查网络连接
- 增加超时时间配置
- 减少单次下载的图片数量
- 考虑使用延迟队列异步处理

## 安全建议

1. ✅ 使用环境变量存储密钥
2. ✅ 不要将密钥提交到代码仓库
3. ✅ 定期轮换密钥
4. ✅ 限制密钥的权限范围
5. ✅ 监控API调用量和费用

## 技术支持

如有问题，请查看：
1. 服务商官方文档
2. 项目日志文件
3. 联系开发团队

