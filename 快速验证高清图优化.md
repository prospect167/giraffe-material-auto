# 快速验证高清图优化

## 🚀 一键启动测试

### 1. 启动服务

```bash
cd /Users/prospect/Documents/code/tcxy/xygj/giraffe-material-auto

# 方式1: 使用 Maven 启动（推荐开发环境）
mvn spring-boot:run

# 方式2: 使用 JAR 包启动
java -jar target/giraffe-material-auto-1.0.0-SNAPSHOT.jar
```

等待看到以下日志表示启动成功：
```
Started MaterialAutoApplication in X.XXX seconds
```

### 2. 快速测试（豆瓣电影）

打开新的终端窗口，执行：

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/1292052/photos?type=S&start=0",
    "targetDir": "test_hd_douban",
    "convertToJpeg": false
  }'
```

### 3. 查看结果

#### 3.1 查看日志（关键信息）

在服务运行的终端中，你应该能看到：

```
✅ 提取到高清图片链接（来自a标签）: https://img9.doubanio.com/view/photo/raw/public/pXXXXXXX.jpg
✅ 升级图片URL为高清: /photo/s/pXXXXXXX.jpg -> /photo/raw/pXXXXXXX.jpg
✅ 提取到 30 个图片URL（已优先使用高清版本）
```

**关键词**：
- `raw` - 豆瓣的高清原图标识
- `升级图片URL为高清` - 说明 URL 转换成功
- `提取到高清图片` - 说明找到了高清属性

#### 3.2 检查下载的图片

```bash
# 进入下载目录
cd downloads/test_hd_douban

# 查看最新下载的文件夹
ls -lt | head -5

# 进入最新的时间戳文件夹
cd $(ls -t | head -1)

# 查看图片大小（应该是 500KB - 5MB）
ls -lh | head -10
```

**预期结果：**
```
-rw-r--r--  1 user  staff   1.2M Jan  7 10:15 p2895695254.jpg  ✅ 高清
-rw-r--r--  1 user  staff   2.3M Jan  7 10:15 p2895695255.jpg  ✅ 高清
-rw-r--r--  1 user  staff   1.8M Jan  7 10:15 p2895695256.jpg  ✅ 高清
```

如果看到的是：
```
-rw-r--r--  1 user  staff    85K Jan  7 10:15 p2895695254.jpg  ❌ 低清（优化前）
```

说明优化未生效。

#### 3.3 查看图片分辨率

```bash
# 使用 sips 命令（macOS 自带）
sips -g pixelWidth -g pixelHeight *.jpg | head -20
```

**预期结果：**
```
pixelWidth: 1600      ✅ 高清
pixelHeight: 1066
pixelWidth: 2000      ✅ 高清
pixelHeight: 1333
```

如果看到的是：
```
pixelWidth: 400       ❌ 低清（优化前）
pixelHeight: 266
```

说明下载的是缩略图。

## 📊 对比验证

### 优化前 vs 优化后

| 指标 | 优化前 | 优化后 | 如何验证 |
|------|--------|--------|----------|
| **URL 路径** | `/s_ratio_poster/` | `/raw/` | 查看日志 |
| **文件大小** | 50-200 KB | 500 KB - 5 MB | `ls -lh` |
| **图片分辨率** | 400×600 | 1500×2250+ | `sips -g` |
| **日志关键词** | 无特殊标识 | "升级图片URL为高清" | 查看日志 |

## 🔍 详细验证步骤

### 步骤 1: 检查 API 响应

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/1292052/photos?type=S&start=0",
    "targetDir": "verify_hd"
  }' | jq .
```

**关注响应中的：**
```json
{
  "data": {
    "success": true,
    "totalCount": 30,      // 下载的图片数量
    "successCount": 28,    // 成功数量
    "failCount": 2,        // 失败数量（可能有些高清图需要权限）
    "savePath": "./downloads/verify_hd/20260107_101500",
    "duration": 125000     // 耗时（高清图会更长）
  }
}
```

### 步骤 2: 对比单张图片

下载一张图片，对比优化前后的差异：

```bash
# 查看第一张图片的详细信息
FIRST_IMG=$(ls downloads/verify_hd/*/p*.jpg | head -1)
echo "图片路径: $FIRST_IMG"
ls -lh "$FIRST_IMG"
sips -g all "$FIRST_IMG" | grep -E "pixelWidth|pixelHeight|fileSize"
```

### 步骤 3: 查看完整日志

```bash
# 查看最新的日志文件
tail -100 logs/giraffe-material-auto.log | grep -E "升级|高清|raw|提取到"
```

**应该看到：**
```
[INFO] 提取到高清图片链接（来自a标签）: https://img9.doubanio.com/view/photo/raw/...
[DEBUG] 升级图片URL为高清: /photo/s/... -> /photo/raw/...
[INFO] 提取到 30 个图片URL（已优先使用高清版本）
```

## ✅ 成功标准

满足以下**任意 3 项**即表示优化成功：

1. ✅ 日志中出现 "升级图片URL为高清" 或 "提取到高清图片"
2. ✅ 豆瓣图片 URL 包含 `/raw/` 而不是 `/s_ratio_poster/`
3. ✅ 单张图片大小在 **500KB - 5MB** 范围内
4. ✅ 图片分辨率在 **1500×1000** 以上
5. ✅ 图片放大后细节清晰，无明显模糊

## ❌ 常见问题

### 问题 1: 图片仍然很小（< 200KB）

**可能原因：**
1. 网站没有提供高清图
2. URL 模式未匹配

**排查方法：**
```bash
# 查看日志，看是否有 URL 升级
tail -50 logs/giraffe-material-auto.log | grep "升级"
```

如果没有看到 "升级" 日志：
- 可能该网站的 URL 模式不在当前规则中
- 需要添加新的转换规则

### 问题 2: 下载失败或超时

**解决方案：**

编辑 `src/main/resources/application.yml`：

```yaml
material:
  download:
    read-timeout: 120000    # 增加到 120 秒
    max-retry: 5           # 增加重试次数
```

然后重新编译启动：
```bash
mvn clean package
mvn spring-boot:run
```

### 问题 3: 返回 403 错误

**原因：** 某些高清图有防盗链保护

**临时解决方案：**
- 使用浏览器直接访问该 URL，看是否能打开
- 如果浏览器能打开，可能需要特殊的 Cookie 或 Token

### 问题 4: 服务启动失败

**检查端口是否被占用：**
```bash
lsof -i :8080
```

如果被占用，修改 `application.yml` 中的端口：
```yaml
server:
  port: 8081  # 改为其他端口
```

## 📝 测试报告模板

测试完成后，可以记录以下信息：

```
测试时间: 2026-01-07 10:15:00
测试 URL: https://movie.douban.com/subject/1292052/photos?type=S
下载数量: 30 张
成功数量: 28 张
失败数量: 2 张

单张图片大小: 1.2 MB - 3.5 MB  ✅
图片分辨率: 1600×1066 - 2000×1333  ✅
URL 类型: /raw/ (高清)  ✅
日志关键词: "升级图片URL为高清"  ✅

结论: ✅ 优化成功，图片清晰度显著提升
```

## 🎯 下一步

验证成功后，可以：

1. **测试其他网站**
   ```bash
   curl -X POST http://localhost:8080/api/v1/download/images \
     -H "Content-Type: application/json" \
     -d '{
       "url": "你想测试的其他网站",
       "targetDir": "test_other_site"
     }'
   ```

2. **批量下载测试**
   ```bash
   curl -X POST http://localhost:8080/api/v1/download/images/batch \
     -H "Content-Type: application/json" \
     -d '{
       "urls": ["url1", "url2", "url3"],
       "targetDir": "batch_hd_test",
       "concurrent": true
     }'
   ```

3. **查看完整文档**
   - [高清图片下载优化说明.md](./高清图片下载优化说明.md)
   - [高清图测试验证.md](./高清图测试验证.md)
   - [CHANGELOG-高清图优化.md](./CHANGELOG-高清图优化.md)

## 💡 提示

- 首次下载可能较慢，因为高清图文件更大
- 建议在 WiFi 环境下测试
- 如果网络不稳定，可以增加 `max-retry` 配置
- 豆瓣网站的高清图效果最明显

---

**祝测试顺利！如有问题，请查看详细文档或联系开发团队。**

