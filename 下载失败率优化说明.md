# ä¸‹è½½å¤±è´¥ç‡ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

é™ä½å›¾ç‰‡ä¸‹è½½å¤±è´¥ç‡ï¼Œä»å½“å‰çš„ **18.4%**ï¼ˆ87ä¸ªä¸­å¤±è´¥16ä¸ªï¼‰é™ä½åˆ° **5%ä»¥ä¸‹**ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜

1. **é”™è¯¯æ—¥å¿—ä¸å¤Ÿè¯¦ç»†**ï¼šåªè®°å½•äº† `e.getMessage()`ï¼Œæ— æ³•å®šä½å…·ä½“å¤±è´¥åŸå› 
2. **æ²¡æœ‰è¯·æ±‚é—´éš”**ï¼šè¿ç»­å¿«é€Ÿè¯·æ±‚å¯èƒ½å¯¼è‡´è¢«é™æµæˆ–å°ç¦
3. **é‡è¯•ç­–ç•¥ç®€å•**ï¼šå›ºå®šé—´éš”1ç§’ï¼Œä¸å¤Ÿçµæ´»
4. **HTTPçŠ¶æ€ç å¤„ç†ä¸è¶³**ï¼šæœªå¤„ç†403ã€429ç­‰ç‰¹æ®ŠçŠ¶æ€ç 
5. **è¯·æ±‚å¤´ä¸å®Œæ•´**ï¼šç¼ºå°‘Refererç­‰å…³é”®è¯·æ±‚å¤´
6. **è¶…æ—¶æ—¶é—´å¯èƒ½ä¸å¤Ÿ**ï¼š30ç§’è¶…æ—¶å¯¹äºæŸäº›æ…¢é€Ÿå›¾ç‰‡å¯èƒ½ä¸å¤Ÿ

---

## âœ… å·²å®æ–½çš„ä¼˜åŒ–

### 1. å¢å¼ºé”™è¯¯æ—¥å¿— ğŸ“

**ä¼˜åŒ–å‰ï¼š**
```java
log.error("ä¸‹è½½å¤±è´¥: {}, é”™è¯¯: {}", imageUrl, e.getMessage());
```

**ä¼˜åŒ–åï¼š**
```java
log.error("ä¸‹è½½å¤±è´¥: {}, åŸå› : {}, é”™è¯¯è¯¦æƒ…", imageUrl, reason, e);
```

**æ”¹è¿›ç‚¹ï¼š**
- âœ… è®°å½•å®Œæ•´çš„å¼‚å¸¸å †æ ˆä¿¡æ¯
- âœ… æå–å¹¶åˆ†ç±»å¤±è´¥åŸå› 
- âœ… æ·»åŠ å¤±è´¥åŸå› ç»Ÿè®¡

**ç¤ºä¾‹æ—¥å¿—ï¼š**
```
2025-12-30 18:30:45.123 [main] ERROR c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:147] - ä¸‹è½½å¤±è´¥: https://example.com/image.jpg, åŸå› : è¿æ¥è¶…æ—¶, é”™è¯¯è¯¦æƒ…
java.net.SocketTimeoutException: Read timed out
    at java.net.SocketInputStream.socketRead0(Native Method)
    ...
```

---

### 2. æ·»åŠ è¯·æ±‚é—´éš” â±ï¸

**æ–°å¢é…ç½®ï¼š**
```yaml
material:
  download:
    # è¯·æ±‚é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé¿å…è¯·æ±‚è¿‡å¿«è¢«é™æµ
    request-interval: 500
```

**å®ç°ï¼š**
```java
// æ·»åŠ è¯·æ±‚é—´éš”ï¼Œé¿å…è¯·æ±‚è¿‡å¿«è¢«é™æµ
if (downloadConfig.getRequestInterval() != null && downloadConfig.getRequestInterval() > 0) {
    Thread.sleep(downloadConfig.getRequestInterval());
}
```

**æ•ˆæœï¼š**
- âœ… æ¯ä¸ªå›¾ç‰‡ä¸‹è½½å‰ç­‰å¾…500msï¼Œé¿å…è¯·æ±‚è¿‡å¿«
- âœ… å¯é…ç½®ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

---

### 3. ä¼˜åŒ–é‡è¯•ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ğŸ”„

**ä¼˜åŒ–å‰ï¼š**
```java
Thread.sleep(1000); // å›ºå®šç­‰å¾…1ç§’
```

**ä¼˜åŒ–åï¼š**
```java
// æŒ‡æ•°é€€é¿ï¼šç¬¬1æ¬¡é‡è¯•ç­‰1ç§’ï¼Œç¬¬2æ¬¡ç­‰2ç§’ï¼Œç¬¬3æ¬¡ç­‰4ç§’
Thread.sleep((long) Math.pow(2, retryCount - 1) * 1000);
```

**é‡è¯•æ—¶é—´è¡¨ï¼š**
| é‡è¯•æ¬¡æ•° | ç­‰å¾…æ—¶é—´ |
|---------|---------|
| ç¬¬1æ¬¡   | 1ç§’     |
| ç¬¬2æ¬¡   | 2ç§’     |
| ç¬¬3æ¬¡   | 4ç§’     |

**æ•ˆæœï¼š**
- âœ… é¿å…é¢‘ç¹é‡è¯•å¯¼è‡´æœåŠ¡å™¨å‹åŠ›è¿‡å¤§
- âœ… ç»™æœåŠ¡å™¨æ›´å¤šæ¢å¤æ—¶é—´
- âœ… æé«˜é‡è¯•æˆåŠŸç‡

---

### 4. å¤„ç†ç‰¹æ®ŠHTTPçŠ¶æ€ç  ğŸš¦

**æ–°å¢å¤„ç†ï¼š**

| çŠ¶æ€ç  | å¤„ç†æ–¹å¼ |
|--------|---------|
| **403** | è®°å½•ä¸º"HTTP 403 ç¦æ­¢è®¿é—®" |
| **429** | è¯»å– `Retry-After` å¤´ï¼Œç­‰å¾…æŒ‡å®šæ—¶é—´åé‡è¯• |
| **503** | è®°å½•ä¸º"HTTP 503 æœåŠ¡ä¸å¯ç”¨" |
| **301/302/307** | è‡ªåŠ¨è·Ÿéšé‡å®šå‘ |

**å®ç°ï¼š**
```java
if (responseCode == HttpURLConnection.HTTP_FORBIDDEN) {
    throw new IOException("HTTP 403 ç¦æ­¢è®¿é—®ï¼Œå¯èƒ½è¢«æœåŠ¡å™¨æ‹’ç»");
} else if (responseCode == 429) {
    String retryAfter = connection.getHeaderField("Retry-After");
    int waitSeconds = retryAfter != null ? Integer.parseInt(retryAfter) : (int) Math.pow(2, retryCount);
    Thread.sleep(waitSeconds * 1000L);
    throw new IOException("HTTP 429 è¯·æ±‚è¿‡å¤šï¼Œéœ€è¦ç­‰å¾…");
}
```

---

### 5. å®Œå–„è¯·æ±‚å¤´ ğŸ“‹

**æ–°å¢è¯·æ±‚å¤´ï¼š**
```java
connection.setRequestProperty("User-Agent", downloadConfig.getUserAgent());
connection.setRequestProperty("Referer", refererUrl);  // æ–°å¢ï¼šæ¥æºURL
connection.setRequestProperty("Accept", "image/webp,image/apng,image/*,*/*;q=0.8");
connection.setRequestProperty("Accept-Language", "zh-CN,zh;q=0.9,en;q=0.8");
connection.setRequestProperty("Accept-Encoding", "gzip, deflate, br");
connection.setRequestProperty("Connection", "keep-alive");
connection.setRequestProperty("Cache-Control", "no-cache");
```

**æ•ˆæœï¼š**
- âœ… æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨è¯·æ±‚
- âœ… è®¾ç½®Refererï¼Œé¿å…é˜²ç›—é“¾
- âœ… æ”¯æŒæ›´å¤šå›¾ç‰‡æ ¼å¼

---

### 6. ä¼˜åŒ–è¶…æ—¶é…ç½® â°

**æ–°å¢é…ç½®ï¼š**
```yaml
material:
  download:
    # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    connect-timeout: 10000
    # è¯»å–è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    read-timeout: 60000
```

**æ”¹è¿›ç‚¹ï¼š**
- âœ… åˆ†ç¦»è¿æ¥è¶…æ—¶å’Œè¯»å–è¶…æ—¶
- âœ… è¿æ¥è¶…æ—¶10ç§’ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
- âœ… è¯»å–è¶…æ—¶60ç§’ï¼ˆç»™å¤§å›¾ç‰‡æ›´å¤šæ—¶é—´ï¼‰

---

### 7. å¤±è´¥åŸå› ç»Ÿè®¡ ğŸ“Š

**æ–°å¢åŠŸèƒ½ï¼š**
```java
// å¤±è´¥åŸå› ç»Ÿè®¡
Map<String, Integer> failureReasons = new HashMap<>();

// æå–å¤±è´¥åŸå› 
String reason = extractFailureReason(e);
failureReasons.put(reason, failureReasons.getOrDefault(reason, 0) + 1);

// æ‰“å°ç»Ÿè®¡
log.warn("ä¸‹è½½å¤±è´¥åŸå› ç»Ÿè®¡:");
failureReasons.forEach((reason, count) -> 
    log.warn("  {}: {} æ¬¡", reason, count)
);
```

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
2025-12-30 18:30:50.123 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:155] - ä¸‹è½½å¤±è´¥åŸå› ç»Ÿè®¡:
2025-12-30 18:30:50.124 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:156] -   è¿æ¥è¶…æ—¶: 8 æ¬¡
2025-12-30 18:30:50.125 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:156] -   HTTP 403 ç¦æ­¢è®¿é—®: 5 æ¬¡
2025-12-30 18:30:50.126 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:156] -   å›¾ç‰‡æ ¼å¼æ— æ•ˆ: 3 æ¬¡
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ä¼˜åŒ–å‰
- **å¤±è´¥ç‡**ï¼š18.4%ï¼ˆ87ä¸ªä¸­å¤±è´¥16ä¸ªï¼‰
- **å¹³å‡è€—æ—¶**ï¼š379ç§’ï¼ˆçº¦6.3åˆ†é’Ÿï¼‰

### ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰
- **å¤±è´¥ç‡**ï¼š< 5%ï¼ˆé¢„è®¡å¤±è´¥ < 5ä¸ªï¼‰
- **å¹³å‡è€—æ—¶**ï¼šå¯èƒ½ç•¥æœ‰å¢åŠ ï¼ˆç”±äºè¯·æ±‚é—´éš”ï¼‰ï¼Œä½†æ›´ç¨³å®š

---

## ğŸ”§ é…ç½®å»ºè®®

### é’ˆå¯¹ä¸åŒåœºæ™¯çš„é…ç½®

#### åœºæ™¯1ï¼šå¿«é€Ÿä¸‹è½½ï¼ˆç½‘ç»œç¨³å®šï¼‰
```yaml
material:
  download:
    request-interval: 200      # 200msé—´éš”
    connect-timeout: 5000       # 5ç§’è¿æ¥è¶…æ—¶
    read-timeout: 30000         # 30ç§’è¯»å–è¶…æ—¶
    max-retry: 2                # æœ€å¤šé‡è¯•2æ¬¡
```

#### åœºæ™¯2ï¼šç¨³å®šä¸‹è½½ï¼ˆç½‘ç»œä¸ç¨³å®šï¼‰
```yaml
material:
  download:
    request-interval: 1000       # 1ç§’é—´éš”
    connect-timeout: 10000      # 10ç§’è¿æ¥è¶…æ—¶
    read-timeout: 60000         # 60ç§’è¯»å–è¶…æ—¶
    max-retry: 5                # æœ€å¤šé‡è¯•5æ¬¡
```

#### åœºæ™¯3ï¼šä¿å®ˆä¸‹è½½ï¼ˆé¿å…è¢«é™æµï¼‰
```yaml
material:
  download:
    request-interval: 2000       # 2ç§’é—´éš”
    connect-timeout: 15000      # 15ç§’è¿æ¥è¶…æ—¶
    read-timeout: 90000         # 90ç§’è¯»å–è¶…æ—¶
    max-retry: 3                # æœ€å¤šé‡è¯•3æ¬¡
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### å¦‚æœå¤±è´¥ç‡ä»ç„¶è¾ƒé«˜

1. **æŸ¥çœ‹å¤±è´¥åŸå› ç»Ÿè®¡**
   ```
   æŸ¥çœ‹æ—¥å¿—ä¸­çš„"ä¸‹è½½å¤±è´¥åŸå› ç»Ÿè®¡"éƒ¨åˆ†
   ```

2. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   ```bash
   ping ç›®æ ‡ç½‘ç«™
   curl -I å›¾ç‰‡URL
   ```

3. **è°ƒæ•´è¯·æ±‚é—´éš”**
   ```yaml
   request-interval: 1000  # å¢åŠ åˆ°1ç§’
   ```

4. **å¢åŠ è¶…æ—¶æ—¶é—´**
   ```yaml
   read-timeout: 120000  # å¢åŠ åˆ°120ç§’
   ```

5. **æ£€æŸ¥User-Agent**
   ```yaml
   user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...
   ```

---

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

### ä¼˜åŒ–åçš„å®Œæ•´æ—¥å¿—

```
2025-12-30 18:30:45.123 [main] INFO  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:58] - å¼€å§‹ä¸‹è½½å›¾ç‰‡ï¼ŒURL: https://movie.douban.com/..., çˆ¬å–æ‰€æœ‰åˆ†é¡µ: true
2025-12-30 18:30:48.456 [main] INFO  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:73] - ä»é¡µé¢ä¸­æå–åˆ° 87 ä¸ªå›¾ç‰‡URL
2025-12-30 18:30:48.789 [main] INFO  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:102] - å›¾ç‰‡å°†ä¿å­˜åˆ°: ./downloads/20251230_183048
2025-12-30 18:30:50.123 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadSingleImage:691] - ä¸‹è½½è¶…æ—¶ï¼Œæ­£åœ¨é‡è¯• (1/3): https://example.com/image1.jpg
2025-12-30 18:30:52.456 [main] DEBUG c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:143] - æˆåŠŸä¸‹è½½: https://example.com/image1.jpg
2025-12-30 18:36:55.789 [main] INFO  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:152] - ä¸‹è½½å®Œæˆï¼Œæ€»æ•°: 87, æˆåŠŸ: 83, å¤±è´¥: 4, è€—æ—¶: 382456ms
2025-12-30 18:36:55.790 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:155] - ä¸‹è½½å¤±è´¥åŸå› ç»Ÿè®¡:
2025-12-30 18:36:55.791 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:156] -   è¿æ¥è¶…æ—¶: 2 æ¬¡
2025-12-30 18:36:55.792 [main] WARN  c.p.g.m.s.ImageDownloadService [ImageDownloadService:downloadImages:156] -   HTTP 403 ç¦æ­¢è®¿é—®: 2 æ¬¡
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

å¦‚æœå¤±è´¥ç‡ä»ç„¶è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **ä½¿ç”¨ä»£ç†æ± **ï¼šé¿å…IPè¢«å°ç¦
2. **å¹¶å‘ä¸‹è½½**ï¼šä½¿ç”¨çº¿ç¨‹æ± æé«˜ä¸‹è½½é€Ÿåº¦
3. **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤ä¸‹è½½ç›¸åŒURL
4. **æ›´æ™ºèƒ½çš„é‡è¯•**ï¼šæ ¹æ®é”™è¯¯ç±»å‹é€‰æ‹©ä¸åŒçš„é‡è¯•ç­–ç•¥
5. **ç›‘æ§å’Œå‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å¤±è´¥ç‡ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ—¥å¿—æ ¼å¼è¯´æ˜.md](./æ—¥å¿—æ ¼å¼è¯´æ˜.md)
- [ä¿å­˜ç›®å½•é…ç½®è¯´æ˜.md](./ä¿å­˜ç›®å½•é…ç½®è¯´æ˜.md)

