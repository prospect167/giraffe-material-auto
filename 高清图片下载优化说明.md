# 高清图片下载优化说明

## 问题描述

之前版本下载的图片都是低清版本（缩略图），与直接复制下载的图片清晰度相差很多。

## 根本原因

原有逻辑只是简单提取 HTML 中 `<img>` 标签的 `src` 属性，而大多数网站为了加载速度，`src` 属性通常指向的是缩略图或压缩后的低清版本。高清原图链接往往存储在其他地方：

1. **数据属性**：`data-rawurl`、`data-highres`、`data-original-url` 等
2. **链接标签**：`<a>` 标签的 `href` 指向高清大图
3. **URL 参数**：通过修改 URL 中的尺寸参数（如 `/s/` 改为 `/raw/`）可获取高清版本

## 优化方案

### 1. 多层级图片提取策略

按照优先级依次提取图片 URL：

**优先级 1：从 `<a>` 标签提取高清图链接**
```java
// 相册页面通常用 <a> 标签链接到高清大图
Elements linkElements = doc.select("a[href]");
```

**优先级 2：提取 `img` 标签的高清属性**
```java
String[] highResAttrs = {
    "data-rawurl",      // 豆瓣等网站的原图URL
    "data-raw",
    "data-highres",
    "data-original-url",
    "data-large",
    "data-hd"
};
```

**优先级 3-5：懒加载属性和背景图**
- `data-src`
- `data-original`  
- `background-image` (CSS)

### 2. URL 智能升级机制

新增 `upgradeToHighResolution()` 方法，自动将低清 URL 转换为高清版本：

#### 豆瓣网站专用规则
```java
// 示例：
// 低清: https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2895695254.jpg
// 高清: https://img9.doubanio.com/view/photo/raw/public/p2895695254.jpg

url.replaceAll("/s_ratio_poster/", "/raw/")
   .replaceAll("/m_ratio_poster/", "/raw/")
   .replaceAll("/l_ratio_poster/", "/raw/")
   .replaceAll("/photo/s/", "/photo/raw/")
   .replaceAll("/photo/m/", "/photo/raw/")
   .replaceAll("/photo/l/", "/photo/raw/")
```

#### 通用规则
```java
// 替换常见的尺寸标识
url.replaceAll("_thumb\\.", "_large.")
   .replaceAll("_small\\.", "_large.")
   .replaceAll("_medium\\.", "_large.")
   .replaceAll("_s\\.", "_l.")
   .replaceAll("_m\\.", "_l.")
```

#### 查询参数优化
```java
// 移除尺寸限制参数
// 例如：image.jpg?w=300&h=200&quality=80 -> image.jpg
queryString.replaceAll("&?w=\\d+", "")
          .replaceAll("&?h=\\d+", "")
          .replaceAll("&?width=\\d+", "")
          .replaceAll("&?height=\\d+", "")
          .replaceAll("&?size=\\w+", "")
          .replaceAll("&?quality=\\d+", "")
```

### 3. 高清图识别机制

新增 `isHighResolutionImage()` 方法，过滤掉明显的缩略图：

```java
// 排除标识
if (url.contains("thumb") || url.contains("small") || 
    url.contains("_s.") || url.contains("_m.") ||
    url.contains("/s/") || url.contains("/m/")) {
    return false;
}
```

## 优化效果

| 对比项 | 优化前 | 优化后 |
|--------|--------|--------|
| 图片来源 | 仅 `<img src>` | `<a href>` + 多种 data-* 属性 |
| URL 处理 | 直接使用原始 URL | 智能升级为高清版本 |
| 豆瓣图片 | `/s_ratio_poster/` (小图) | `/raw/` (原图) |
| 通用网站 | `_small.jpg` | `_large.jpg` |
| URL 参数 | 保留所有参数 | 移除尺寸限制参数 |
| 清晰度 | ⭐⭐ (缩略图级别) | ⭐⭐⭐⭐⭐ (原图级别) |

## 使用方法

无需修改 API 调用方式，原有接口保持不变：

```json
{
  "url": "https://movie.douban.com/subject/36686673/all_photos",
  "targetDir": "douban_movie",
  "convertToJpeg": true
}
```

服务会自动使用优化后的高清图片提取逻辑。

## 支持的网站

### 完全支持（有专用优化规则）
- ✅ 豆瓣（douban.com / doubanio.com）
- ✅ 通用规则适用的大部分网站

### 通用支持
- ✅ 所有包含 `data-rawurl`、`data-highres` 等高清属性的网站
- ✅ 使用 `<a>` 标签链接到大图的相册网站
- ✅ URL 中包含尺寸标识（thumb/small/medium）的网站

## 日志增强

优化后的代码会在日志中显示更多有用信息：

```
提取到高清图片链接（来自a标签）: https://example.com/photo/raw/12345.jpg
提取到高清图片（data-rawurl）: https://img.doubanio.com/view/photo/raw/public/p12345.jpg
升级图片URL为高清: /photo/s/12345.jpg -> /photo/raw/12345.jpg
提取到 50 个图片URL（已优先使用高清版本）
```

## 注意事项

1. **文件体积增大**：高清图片文件体积通常是缩略图的 10-100 倍，需要更多存储空间
2. **下载时间增加**：高清图片下载耗时更长，建议适当增加超时时间
3. **网络流量**：会消耗更多网络流量
4. **某些 URL 可能失效**：部分网站的高清图可能需要特殊权限或防盗链

## 建议配置

如果下载高清图时遇到超时问题，建议调整配置：

```yaml
material:
  download:
    # 增加超时时间
    timeout: 60000          # 从 30s 增加到 60s
    read-timeout: 120000    # 读取超时 120s
    connect-timeout: 15000  # 连接超时 15s
    # 增加重试次数
    max-retry: 5            # 从 3 次增加到 5 次
    # 增加请求间隔
    request-interval: 1000  # 每张图片间隔 1 秒
```

## 测试验证

可以通过以下方式验证优化效果：

1. **对比文件大小**：优化后的图片应该明显大于之前版本
2. **查看图片分辨率**：使用图片查看工具检查分辨率（像素尺寸）
3. **视觉对比**：将图片放大查看细节，应该更清晰
4. **检查日志**：查看日志中是否有 "升级图片URL为高清" 的提示

## 后续扩展

如需支持更多网站的高清图提取规则，可以在 `upgradeToHighResolution()` 方法中添加：

```java
// 示例：添加新网站规则
if (url.contains("example.com")) {
    upgradedUrl = url.replaceAll("/preview/", "/original/");
}
```

## 更新日期

2026-01-07

---

如有问题或建议，请联系开发团队。

