# 高清图优化效果验证指南

## 快速验证步骤

### 1. 重新编译项目

```bash
cd /Users/prospect/Documents/code/tcxy/xygj/giraffe-material-auto
mvn clean package
```

### 2. 启动服务

```bash
java -jar target/giraffe-material-auto-1.0.0-SNAPSHOT.jar
```

或使用 Maven：

```bash
mvn spring-boot:run
```

### 3. 测试下载（以豆瓣电影为例）

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/36686673/all_photos",
    "targetDir": "test_hd_download",
    "convertToJpeg": false
  }'
```

## 验证方法

### 方法 1：查看日志输出

优化后的日志会显示：

```
[INFO] 提取到高清图片链接（来自a标签）: https://img9.doubanio.com/view/photo/raw/public/p2895695254.jpg
[DEBUG] 提取到高清图片（data-rawurl）: ...
[DEBUG] 升级图片URL为高清: /photo/s/12345.jpg -> /photo/raw/12345.jpg
[INFO] 提取到 50 个图片URL（已优先使用高清版本）
```

关键词：
- ✅ "提取到高清图片"
- ✅ "升级图片URL为高清"
- ✅ "/raw/" 路径（豆瓣高清标识）

### 方法 2：对比文件大小

**预期效果：**

| 版本 | 单张图片大小 | 说明 |
|------|-------------|------|
| 优化前 | 50-200 KB | 缩略图（s_ratio_poster） |
| 优化后 | 500 KB - 5 MB | 高清原图（raw） |

**验证命令：**

```bash
# 进入下载目录
cd downloads/test_hd_download/

# 查看最新下载的文件
ls -lh $(ls -t | head -1)

# 统计所有图片的平均大小
du -sh * | awk '{print $1}'
```

### 方法 3：检查图片分辨率

**预期效果：**

| 版本 | 分辨率 | 说明 |
|------|--------|------|
| 优化前 | 400×600 左右 | 低清 |
| 优化后 | 1500×2250 以上 | 高清 |

**macOS 验证：**

```bash
# 查看图片信息
sips -g pixelWidth -g pixelHeight downloads/test_hd_download/*/p*.jpg
```

**或使用 ImageMagick：**

```bash
identify downloads/test_hd_download/*/p*.jpg
```

### 方法 4：检查 URL 格式

查看日志或响应中的图片 URL，应该包含以下特征之一：

**豆瓣网站（优化后）：**
```
✅ https://img9.doubanio.com/view/photo/raw/public/p2895695254.jpg
   （包含 /raw/ 路径）

❌ https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2895695254.jpg
   （包含 /s_ratio_poster/ 是低清版本）
```

**通用网站（优化后）：**
```
✅ https://example.com/images/photo_large.jpg
✅ https://example.com/images/photo_l.jpg
✅ https://example.com/images/photo.jpg  （移除了尺寸参数）

❌ https://example.com/images/photo_small.jpg
❌ https://example.com/images/photo_s.jpg
❌ https://example.com/images/photo.jpg?w=300&h=200
```

## 对比测试

### 测试用例 1：豆瓣电影剧照

```bash
# 下载测试
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/1292052/all_photos",
    "targetDir": "test_douban_hd"
  }'
```

**预期结果：**
- 图片大小：单张 800KB - 3MB
- 图片分辨率：1600×1066 或更高
- URL 包含：`/raw/` 路径

### 测试用例 2：批量下载对比

```bash
curl -X POST http://localhost:8080/api/v1/download/images/batch \
  -H "Content-Type: application/json" \
  -d '{
    "urls": [
      "https://movie.douban.com/subject/1292052/photos?type=S",
      "https://movie.douban.com/subject/1291546/photos?type=S"
    ],
    "targetDir": "test_batch_hd",
    "concurrent": true
  }'
```

## 性能影响说明

### 下载时间对比

| 场景 | 优化前 | 优化后 | 说明 |
|------|--------|--------|------|
| 单张图片 | 0.5-1 秒 | 2-5 秒 | 文件更大需要更多时间 |
| 50 张图片 | 30 秒 | 2-3 分钟 | 总体时间增加 |

### 存储空间对比

| 场景 | 优化前 | 优化后 | 差异 |
|------|--------|--------|------|
| 单张图片 | 100 KB | 1.5 MB | 15 倍 |
| 100 张图片 | 10 MB | 150 MB | 15 倍 |

### 网络流量

下载高清图片会消耗更多网络流量，建议在 WiFi 环境下使用。

## 常见问题排查

### Q1: 下载的图片仍然很小

**可能原因：**
1. 网站没有提供高清图片
2. 需要登录或特殊权限
3. 网站使用了新的 URL 模式

**排查方法：**
```bash
# 查看详细日志
tail -f logs/giraffe-material-auto.log | grep "升级"
```

如果没有看到 "升级图片URL为高清" 的日志，说明：
- 网站可能直接提供的就是高清图
- 或者 URL 模式不匹配当前规则

### Q2: 下载超时

**解决方案：**

编辑 `application.yml`：

```yaml
material:
  download:
    timeout: 60000          # 增加到 60 秒
    read-timeout: 120000    # 读取超时 120 秒
    connect-timeout: 15000  # 连接超时 15 秒
    max-retry: 5            # 增加重试次数
    request-interval: 1500  # 增加请求间隔
```

### Q3: 某些图片返回 403 错误

**原因：** 高清图可能有防盗链保护

**解决方案：**
1. 确保请求头包含正确的 Referer
2. 使用去水印功能（如果网站允许）
3. 降级使用中等清晰度的图片

## 完整测试脚本

```bash
#!/bin/bash

echo "=== 高清图下载优化测试 ==="
echo ""

# 1. 测试豆瓣电影
echo "测试 1: 豆瓣电影剧照"
curl -s -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/1292052/photos?type=S&start=0",
    "targetDir": "test_douban_hd",
    "convertToJpeg": false
  }' | jq .

echo ""
echo "等待 5 秒..."
sleep 5

# 2. 检查文件大小
echo ""
echo "测试 2: 检查下载的图片大小"
DOWNLOAD_DIR=$(find downloads/test_douban_hd -type d -name "2026*" | head -1)
if [ -d "$DOWNLOAD_DIR" ]; then
    echo "下载目录: $DOWNLOAD_DIR"
    echo "文件列表:"
    ls -lh "$DOWNLOAD_DIR" | head -10
    echo ""
    echo "总大小:"
    du -sh "$DOWNLOAD_DIR"
    
    # 3. 检查图片分辨率
    echo ""
    echo "测试 3: 检查图片分辨率"
    FIRST_IMAGE=$(ls "$DOWNLOAD_DIR"/*.jpg 2>/dev/null | head -1)
    if [ -f "$FIRST_IMAGE" ]; then
        echo "样例图片: $FIRST_IMAGE"
        sips -g pixelWidth -g pixelHeight "$FIRST_IMAGE" 2>/dev/null || \
        file "$FIRST_IMAGE"
    fi
else
    echo "未找到下载目录"
fi

echo ""
echo "=== 测试完成 ==="
```

保存为 `test_hd.sh`，然后执行：

```bash
chmod +x test_hd.sh
./test_hd.sh
```

## 成功标准

如果看到以下现象，说明优化成功：

✅ **日志中出现** "升级图片URL为高清" 或 "提取到高清图片"  
✅ **豆瓣图片 URL 包含** `/raw/` 而不是 `/s_ratio_poster/`  
✅ **单张图片大小** 在 500KB - 5MB 范围内  
✅ **图片分辨率** 在 1500×1000 以上  
✅ **图片放大后** 细节清晰，无明显模糊

## 反馈与改进

如果遇到问题，请提供：
1. 测试的目标 URL
2. 完整的日志输出
3. 下载的图片样例
4. 图片的实际分辨率和文件大小

这将帮助我们进一步优化高清图提取规则。

---

更新日期：2026-01-07

