# 部署说明

## 开发环境部署

### 1. 本地运行

```bash
# 使用 Maven 运行（推荐用于开发）
mvn spring-boot:run

# 或使用启动脚本
./start.sh        # Linux/Mac
start.bat         # Windows
```

### 2. 指定配置文件

```bash
# 使用开发环境配置
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 使用生产环境配置
mvn spring-boot:run -Dspring-boot.run.profiles=prod
```

## 生产环境部署

### 1. 编译打包

```bash
mvn clean package -DskipTests
```

编译完成后，jar 包位于 `target/giraffe-material-auto-1.0.0-SNAPSHOT.jar`

### 2. 服务器部署

#### 方式一：直接运行

```bash
# 后台运行
nohup java -jar target/giraffe-material-auto-1.0.0-SNAPSHOT.jar \
  --spring.profiles.active=prod > logs/app.log 2>&1 &

# 查看日志
tail -f logs/app.log
```

#### 方式二：使用 systemd（推荐）

创建服务文件 `/etc/systemd/system/giraffe-material-auto.service`：

```ini
[Unit]
Description=Giraffe Material Auto Service
After=network.target

[Service]
Type=simple
User=appuser
WorkingDirectory=/opt/giraffe-material-auto
ExecStart=/usr/bin/java -jar /opt/giraffe-material-auto/target/giraffe-material-auto-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
# 重载 systemd 配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start giraffe-material-auto

# 设置开机自启
sudo systemctl enable giraffe-material-auto

# 查看状态
sudo systemctl status giraffe-material-auto

# 查看日志
sudo journalctl -u giraffe-material-auto -f
```

#### 方式三：Docker 部署

创建 `Dockerfile`：

```dockerfile
FROM openjdk:8-jdk-alpine
VOLUME /tmp
ARG JAR_FILE=target/giraffe-material-auto-1.0.0-SNAPSHOT.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/app.jar"]
```

构建和运行：

```bash
# 构建镜像
docker build -t giraffe-material-auto:1.0.0 .

# 运行容器
docker run -d \
  --name giraffe-material-auto \
  -p 8080:8080 \
  -v /data/downloads:/data/downloads \
  -e SPRING_PROFILES_ACTIVE=prod \
  giraffe-material-auto:1.0.0

# 查看日志
docker logs -f giraffe-material-auto
```

## 环境变量配置

可以通过环境变量覆盖配置：

```bash
export SERVER_PORT=8080
export MATERIAL_DOWNLOAD_BASE_PATH=/data/downloads
export MATERIAL_DOWNLOAD_TIMEOUT=60000
export MATERIAL_DOWNLOAD_MAX_RETRY=5

java -jar target/giraffe-material-auto-1.0.0-SNAPSHOT.jar
```

## 监控和维护

### 1. 健康检查

```bash
curl http://localhost:8080/api/v1/download/health
```

### 2. 日志管理

生产环境日志路径：`logs/giraffe-material-auto.log`

建议配置日志轮转，避免日志文件过大。

### 3. 磁盘空间监控

定期清理下载目录，避免磁盘空间耗尽：

```bash
# 删除 7 天前的下载文件
find /data/downloads -type f -mtime +7 -delete

# 或设置 crontab 自动清理
0 2 * * * find /data/downloads -type f -mtime +7 -delete
```

## 性能优化建议

### 1. JVM 参数调优

```bash
java -Xms512m -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -jar target/giraffe-material-auto-1.0.0-SNAPSHOT.jar
```

### 2. 并发控制

如果需要处理大量并发请求，建议：

- 增加线程池配置
- 使用消息队列异步处理
- 部署多实例 + 负载均衡

### 3. 反向代理

使用 Nginx 作为反向代理：

```nginx
upstream giraffe_material_auto {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name your-domain.com;

    location /api/ {
        proxy_pass http://giraffe_material_auto;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 60s;
        proxy_read_timeout 300s;
    }
}
```

## 故障排查

### 1. 服务无法启动

- 检查端口是否被占用：`lsof -i:8080`
- 检查 Java 版本：`java -version`（需要 1.8+）
- 查看完整日志

### 2. 下载失败

- 检查网络连接
- 检查目标网站是否可访问
- 查看日志中的详细错误信息
- 尝试增加 timeout 配置

### 3. 磁盘空间不足

- 检查磁盘使用：`df -h`
- 清理旧的下载文件
- 修改 `base-path` 配置到更大的磁盘

## 安全建议

1. 不要将服务直接暴露在公网
2. 使用 Nginx 或 API 网关进行访问控制
3. 添加认证和授权机制
4. 限制单次下载的图片数量
5. 定期更新依赖包，修复安全漏洞

## 备份策略

建议定期备份：

- 应用配置文件
- 下载的图片文件（如需要）
- 日志文件（用于审计）

