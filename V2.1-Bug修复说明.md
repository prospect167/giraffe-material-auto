# V2.1 Bug ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ
```
ä¸‹è½½æœ‰é—®é¢˜ï¼ŒURLè¿”å›çš„ä¸æ˜¯å›¾ç‰‡ç±»å‹: 
https://movie.douban.com/photos/photo/2503257247/#title-anchor
Content-Type: text/html; charset=utf-8

é”™è¯¯: æ— æ³•è¯»å–å›¾ç‰‡å†…å®¹ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼
```

### é—®é¢˜åˆ†æ

ä»æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œ**ä¸‹è½½çš„æ˜¯è¯¦æƒ…é¡µ URLï¼Œè€Œä¸æ˜¯å›¾ç‰‡ URL**ï¼š

**é”™è¯¯çš„ URL**ï¼š
```
https://movie.douban.com/photos/photo/2503257247/#title-anchor
â†‘ è¿™æ˜¯è¯¦æƒ…é¡µURLï¼ˆHTMLé¡µé¢ï¼‰ï¼Œä¸æ˜¯å›¾ç‰‡URL
```

**æ­£ç¡®çš„ URL åº”è¯¥æ˜¯**ï¼š
```
https://img3.doubanio.com/view/photo/photo/public/p2503257247.jpg
â†‘ è¿™æ‰æ˜¯å›¾ç‰‡URLï¼ˆ.jpgæ–‡ä»¶ï¼‰
```

---

## ğŸ” æ ¹æœ¬åŸå› 

é€šè¿‡åˆ†ææ—¥å¿—å‘ç°äº†ä¸¤ä¸ªé—®é¢˜ï¼š

### é—®é¢˜ 1ï¼šV2.0 é€»è¾‘æœªæ‰§è¡Œ

ä»æ—¥å¿—ä¸­çœ‹åˆ°ï¼š
```
âœ— æ²¡æœ‰ "æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢" çš„æ—¥å¿—
âœ— æ²¡æœ‰ "è®¿é—®è¯¦æƒ…é¡µ" çš„æ—¥å¿—
âœ— åªæœ‰ "å‡çº§å›¾ç‰‡URLä¸ºé«˜æ¸…" çš„V1.0æ—¥å¿—
```

**åŸå› **ï¼šæœåŠ¡ä½¿ç”¨çš„æ˜¯æ—§ä»£ç ï¼Œæ²¡æœ‰é‡å¯æˆ–é‡æ–°ç¼–è¯‘

### é—®é¢˜ 2ï¼šV1.0 æ¨¡å¼é”™è¯¯æå–è¯¦æƒ…é¡µé“¾æ¥

V1.0 çš„ä»£ç ä¸­ï¼Œä» `<a>` æ ‡ç­¾æå–å›¾ç‰‡é“¾æ¥çš„é€»è¾‘æœ‰ç¼ºé™·ï¼š
- å®ƒä¼šå°†è¯¦æƒ…é¡µé“¾æ¥è¯¯è®¤ä¸ºæ˜¯å›¾ç‰‡é“¾æ¥
- ä¾‹å¦‚ï¼š`<a href="/photos/photo/2503257247/#title-anchor">` è¢«å½“ä½œäº†å›¾ç‰‡URL

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šå¢å¼º V2.0 çš„æ—¥å¿—å’Œå®¹é”™

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
2. âœ… æ£€æµ‹è±†ç“£ç›¸å†Œé¡µé¢æ—¶æ·»åŠ æ—¥å¿—
3. âœ… ç¡®ä¿æå–çš„æ˜¯å›¾ç‰‡URLè€Œä¸æ˜¯è¯¦æƒ…é¡µURL
4. âœ… å¢åŠ  URL æœ‰æ•ˆæ€§éªŒè¯

**ä¿®æ”¹å‰**ï¼š
```java
if (pageUrl.contains("douban.com") && pageUrl.contains("/photos")) {
    Set<String> detailPageUrls = extractDoubanPhotoDetailUrls(doc);
    for (String detailUrl : detailPageUrls) {
        String ultraHdUrl = extractUltraHdImageFromDoubanDetail(detailUrl);
        imageUrls.add(ultraHdUrl);  // âŒ æ²¡æœ‰éªŒè¯
    }
}
```

**ä¿®æ”¹å**ï¼š
```java
boolean isDoubanAlbum = pageUrl.contains("douban.com") && 
                       (pageUrl.contains("/photos") || pageUrl.contains("/all_photos"));

if (isDoubanAlbum) {
    log.info("æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢: {}", pageUrl);  // âœ… æ·»åŠ æ—¥å¿—
    Set<String> detailPageUrls = extractDoubanPhotoDetailUrls(doc);
    
    if (!detailPageUrls.isEmpty()) {
        log.info("æ‰¾åˆ° {} ä¸ªå›¾ç‰‡è¯¦æƒ…é¡µï¼Œå¼€å§‹æå–è¶…é«˜æ¸…å›¾", detailPageUrls.size());
        
        for (String detailUrl : detailPageUrls) {
            String ultraHdUrl = extractUltraHdImageFromDoubanDetail(detailUrl);
            
            // âœ… éªŒè¯æ˜¯å›¾ç‰‡URL
            if (ultraHdUrl != null && isValidImageUrl(ultraHdUrl)) {
                imageUrls.add(ultraHdUrl);
                log.debug("âœ“ ä»è¯¦æƒ…é¡µæå–åˆ°è¶…é«˜æ¸…å›¾: {}", ultraHdUrl);
            } else {
                log.warn("âœ— æå–çš„ä¸æ˜¯å›¾ç‰‡URL: {}", ultraHdUrl);
            }
        }
    }
}
```

### ä¿®å¤ 2ï¼šæ”¹è¿›è¯¦æƒ…é¡µé“¾æ¥æå–

**é—®é¢˜**ï¼šæå–çš„è¯¦æƒ…é¡µé“¾æ¥åŒ…å«é”šç‚¹ï¼ˆ`#title-anchor`ï¼‰

**ä¿®æ”¹å‰**ï¼š
```java
private Set<String> extractDoubanPhotoDetailUrls(Document doc) {
    Elements photoLinks = doc.select("a[href*=/photos/photo/]");
    for (Element link : photoLinks) {
        String href = link.absUrl("href");
        detailUrls.add(href);  // âŒ åŒ…å«é”šç‚¹å’ŒæŸ¥è¯¢å‚æ•°
    }
}
```

**ä¿®æ”¹å**ï¼š
```java
private Set<String> extractDoubanPhotoDetailUrls(Document doc) {
    Elements photoLinks = doc.select("a[href*=/photos/photo/]");
    
    for (Element link : photoLinks) {
        String href = link.absUrl("href");
        
        // âœ… ç§»é™¤é”šç‚¹
        if (href.contains("#")) {
            href = href.substring(0, href.indexOf("#"));
        }
        
        // âœ… ç§»é™¤æŸ¥è¯¢å‚æ•°
        if (href.contains("?")) {
            href = href.substring(0, href.indexOf("?"));
        }
        
        // âœ… ç¡®ä¿æ ¼å¼æ­£ç¡®
        if (!href.endsWith("/")) {
            href = href + "/";
        }
        
        detailUrls.add(href);
        log.debug("æå–åˆ°è¯¦æƒ…é¡µé“¾æ¥: {}", href);
    }
    
    log.info("ä»ç›¸å†Œé¡µé¢æå–åˆ° {} ä¸ªè¯¦æƒ…é¡µé“¾æ¥", detailUrls.size());
    return detailUrls;
}
```

### ä¿®å¤ 3ï¼šå¢å¼ºè¯¦æƒ…é¡µå›¾ç‰‡æå–

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
2. âœ… ä¼˜å…ˆæŸ¥æ‰¾ä¸»å›¾ç‰‡æ ‡ç­¾
3. âœ… å¢åŠ æ›´å¤šé€‰æ‹©å™¨
4. âœ… æ·»åŠ  Referer è¯·æ±‚å¤´

**ä¿®æ”¹å**ï¼š
```java
private String extractUltraHdImageFromDoubanDetail(String detailPageUrl) {
    log.debug("æ­£åœ¨è®¿é—®è¯¦æƒ…é¡µ: {}", detailPageUrl);
    
    Document detailDoc = Jsoup.connect(detailPageUrl)
            .userAgent(downloadConfig.getUserAgent())
            .timeout(downloadConfig.getTimeout())
            .referrer(detailPageUrl)  // âœ… æ·»åŠ  Referer
            .get();
    
    // ç­–ç•¥1: æŸ¥æ‰¾ä¸»å›¾ç‰‡æ ‡ç­¾ï¼ˆå¢å¼ºé€‰æ‹©å™¨ï¼‰
    Elements mainImages = detailDoc.select(
        "div.photo-wp img, div.mainphoto img, img#mainpic, img.view_photo"  // âœ… æ›´å¤šé€‰æ‹©å™¨
    );
    
    if (!mainImages.isEmpty()) {
        Element mainImg = mainImages.first();
        log.debug("æ‰¾åˆ°ä¸»å›¾ç‰‡æ ‡ç­¾");
        
        String[] hdAttrs = {
            "data-rawurl",      // è±†ç“£åŸå›¾
            "data-original",    // æ‡’åŠ è½½åŸå›¾
            "data-src",         // æ‡’åŠ è½½
            "src"               // æœ€åå°è¯•
        };
        
        for (String attr : hdAttrs) {
            String imgUrl = mainImg.absUrl(attr);
            log.debug("æ£€æŸ¥å±æ€§ [{}]: {}", attr, imgUrl);  // âœ… è¯¦ç»†æ—¥å¿—
            
            if (imgUrl != null && isValidImageUrl(imgUrl)) {
                String ultraHdUrl = upgradeToUltraHighResolution(imgUrl);
                log.info("âœ“ æˆåŠŸæå–å›¾ç‰‡URLï¼ˆå±æ€§: {}ï¼‰: {}", attr, ultraHdUrl);
                return ultraHdUrl;
            }
        }
    }
    
    log.error("âœ— æ— æ³•ä»è¯¦æƒ…é¡µæå–è¶…é«˜æ¸…å›¾: {}", detailPageUrl);
    return null;
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„æ—¥å¿—

```
[DEBUG] å‡çº§å›¾ç‰‡URLä¸ºé«˜æ¸…: .../photo/m/... -> .../photo/raw/...
[INFO] æå–åˆ° 25 ä¸ªå›¾ç‰‡URLï¼ˆå·²ä¼˜å…ˆä½¿ç”¨é«˜æ¸…ç‰ˆæœ¬ï¼‰
[WARN] URLè¿”å›çš„ä¸æ˜¯å›¾ç‰‡ç±»å‹: https://movie.douban.com/photos/photo/2503257247/#title-anchor
[ERROR] ä¸‹è½½å¤±è´¥: æ— æ³•è¯»å–å›¾ç‰‡å†…å®¹
```

**é—®é¢˜**ï¼š
- âŒ æ²¡æœ‰æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢
- âŒ æ²¡æœ‰è®¿é—®è¯¦æƒ…é¡µ
- âŒ ä¸‹è½½äº†è¯¦æƒ…é¡µURLè€Œä¸æ˜¯å›¾ç‰‡URL

### ä¿®å¤åçš„æ—¥å¿—

```
[INFO] æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢: https://movie.douban.com/subject/26909315/photos?type=R
[INFO] ä»ç›¸å†Œé¡µé¢æå–åˆ° 25 ä¸ªè¯¦æƒ…é¡µé“¾æ¥
[INFO] æ‰¾åˆ° 25 ä¸ªå›¾ç‰‡è¯¦æƒ…é¡µï¼Œå¼€å§‹æå–è¶…é«˜æ¸…å›¾
[DEBUG] æ­£åœ¨è®¿é—®è¯¦æƒ…é¡µ: https://movie.douban.com/photos/photo/2503257247/
[DEBUG] æ‰¾åˆ°ä¸»å›¾ç‰‡æ ‡ç­¾
[DEBUG] æ£€æŸ¥å±æ€§ [data-rawurl]: https://img3.doubanio.com/view/photo/raw/public/p2503257247.jpg
[INFO] âœ“ æˆåŠŸæå–å›¾ç‰‡URLï¼ˆå±æ€§: data-rawurlï¼‰: https://img3.doubanio.com/view/photo/photo/public/p2503257247.jpg
[INFO] æˆåŠŸä» 25 ä¸ªè¯¦æƒ…é¡µæå–åˆ°è¶…é«˜æ¸…å›¾
[DEBUG] æˆåŠŸä¸‹è½½: https://img3.doubanio.com/view/photo/photo/public/p2503257247.jpg
```

**æ”¹è¿›**ï¼š
- âœ… æ­£ç¡®æ£€æµ‹è±†ç“£ç›¸å†Œé¡µé¢
- âœ… æˆåŠŸè®¿é—®è¯¦æƒ…é¡µ
- âœ… æå–åˆ°æ­£ç¡®çš„å›¾ç‰‡URLï¼ˆ.jpgæ–‡ä»¶ï¼‰
- âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å¸®åŠ©æ’æŸ¥é—®é¢˜

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. é‡å¯æœåŠ¡ï¼ˆé‡è¦ï¼ï¼‰

**åœæ­¢æ—§æœåŠ¡**ï¼š
```bash
# å¦‚æœæœåŠ¡åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
ps aux | grep giraffe-material-auto | grep -v grep | awk '{print $2}' | xargs kill
```

**å¯åŠ¨æ–°æœåŠ¡**ï¼š
```bash
cd /Users/prospect/Documents/code/tcxy/xygj/giraffe-material-auto
mvn spring-boot:run
```

### 2. æµ‹è¯•ä¸‹è½½

```bash
curl -X POST http://localhost:8080/api/v1/download/images \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://movie.douban.com/subject/26909315/photos?type=R",
    "targetDir": "test_v2.1",
    "crawlAllPages": false
  }'
```

### 3. æŸ¥çœ‹æ—¥å¿—éªŒè¯

```bash
tail -f logs/giraffe-material-auto.log | grep -E "æ£€æµ‹åˆ°è±†ç“£|è¯¦æƒ…é¡µ|è¶…é«˜æ¸…|âœ“|âœ—"
```

**æˆåŠŸæ ‡å¿—**ï¼š
```
âœ… [INFO] æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢
âœ… [INFO] ä»ç›¸å†Œé¡µé¢æå–åˆ° X ä¸ªè¯¦æƒ…é¡µé“¾æ¥
âœ… [INFO] æ‰¾åˆ° X ä¸ªå›¾ç‰‡è¯¦æƒ…é¡µï¼Œå¼€å§‹æå–è¶…é«˜æ¸…å›¾
âœ… [DEBUG] æ­£åœ¨è®¿é—®è¯¦æƒ…é¡µ
âœ… [INFO] âœ“ æˆåŠŸæå–å›¾ç‰‡URL
âœ… [INFO] æˆåŠŸä» X ä¸ªè¯¦æƒ…é¡µæå–åˆ°è¶…é«˜æ¸…å›¾
âœ… [DEBUG] æˆåŠŸä¸‹è½½: https://img3.doubanio.com/view/photo/photo/public/pXXXXXXX.jpg
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¿…é¡»é‡å¯æœåŠ¡

**éå¸¸é‡è¦**ï¼šä¿®å¤ä»£ç åå¿…é¡»é‡å¯æœåŠ¡ï¼Œå¦åˆ™ä¼šç»§ç»­ä½¿ç”¨æ—§ä»£ç ï¼

```bash
# åœæ­¢æ—§æœåŠ¡
pkill -f giraffe-material-auto

# å¯åŠ¨æ–°æœåŠ¡
mvn spring-boot:run
```

### 2. ç¡®è®¤æ—¥å¿—æ­£å¸¸

å¯åŠ¨åç«‹å³æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤æ²¡æœ‰å¯åŠ¨é”™è¯¯ï¼š

```bash
tail -20 logs/giraffe-material-auto.log
```

### 3. é¦–æ¬¡æµ‹è¯•å»ºè®®

**ç¬¬ä¸€æ¬¡æµ‹è¯•å»ºè®®**ï¼š
- ä½¿ç”¨å°‘é‡å›¾ç‰‡çš„ç›¸å†Œï¼ˆ`crawlAllPages: false`ï¼‰
- å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼ˆ`tail -f logs/giraffe-material-auto.log`ï¼‰
- ç¡®è®¤çœ‹åˆ° "æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢" æ—¥å¿—

### 4. å¦‚æœä»ç„¶å‡ºé”™

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **æ£€æŸ¥æ˜¯å¦é‡å¯æœåŠ¡**
   ```bash
   ps aux | grep giraffe-material-auto
   ```

2. **æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰æ–°çš„é”™è¯¯**
   ```bash
   tail -50 logs/giraffe-material-auto.log
   ```

3. **ç¡®è®¤ç¼–è¯‘æˆåŠŸ**
   ```bash
   mvn clean compile
   ```

4. **æ¸…ç©ºæ—§çš„ä¸‹è½½ç›®å½•**
   ```bash
   rm -rf downloads/*
   ```

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| V1.0 | 2026-01-07 | åˆå§‹é«˜æ¸…å›¾ä¼˜åŒ– |
| V2.0 | 2026-01-07 | è¶…é«˜æ¸…å›¾è¯¦æƒ…é¡µæå– |
| V2.1 | 2026-01-07 | **Bugä¿®å¤ï¼šæ­£ç¡®æå–å›¾ç‰‡URL** |

---

## ğŸ¯ ä¿®å¤æ€»ç»“

### ä¿®å¤çš„é—®é¢˜

1. âœ… **V2.0 é€»è¾‘æœªæ‰§è¡Œ** - å¢å¼ºæ—¥å¿—è¾“å‡ºï¼Œä¾¿äºéªŒè¯
2. âœ… **è¯¦æƒ…é¡µURLåŒ…å«é”šç‚¹** - ç§»é™¤é”šç‚¹å’ŒæŸ¥è¯¢å‚æ•°
3. âœ… **ä¸‹è½½è¯¦æƒ…é¡µè€Œä¸æ˜¯å›¾ç‰‡** - å¢åŠ URLæœ‰æ•ˆæ€§éªŒè¯
4. âœ… **è°ƒè¯•å›°éš¾** - æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### æ–°å¢æ—¥å¿—æ ‡è®°

- `âœ“` - æˆåŠŸæ“ä½œ
- `âœ—` - å¤±è´¥æ“ä½œ
- `æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢` - V2.0 å¯åŠ¨
- `ä»è¯¦æƒ…é¡µæå–åˆ°è¶…é«˜æ¸…å›¾` - æå–æˆåŠŸ
- `å›é€€åˆ°æ™®é€šæ¨¡å¼` - V2.0 å¤±è´¥ï¼Œå›é€€åˆ° V1.0

### éªŒè¯æ¸…å•

- [ ] æœåŠ¡å·²é‡å¯
- [ ] æ—¥å¿—ä¸­å‡ºç° "æ£€æµ‹åˆ°è±†ç“£ç›¸å†Œé¡µé¢"
- [ ] æ—¥å¿—ä¸­å‡ºç° "âœ“ æˆåŠŸæå–å›¾ç‰‡URL"
- [ ] ä¸‹è½½çš„URLæ˜¯å›¾ç‰‡æ–‡ä»¶ï¼ˆ.jpgï¼‰
- [ ] å›¾ç‰‡æ–‡ä»¶å¤§å° > 1 MB
- [ ] å›¾ç‰‡å¯ä»¥æ­£å¸¸æ‰“å¼€

---

**æ›´æ–°æ—¥æœŸ**: 2026-01-07  
**ç‰ˆæœ¬**: V2.1  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶é€šè¿‡ç¼–è¯‘éªŒè¯

**é‡è¦æé†’**ï¼šä¿®å¤åè¯·åŠ¡å¿…é‡å¯æœåŠ¡ï¼

